name: Reusable Build Workflow

on:
  workflow_call:
    inputs:
      matrix-json:
        required: true
        type: string
        description: "JSON array of build configurations. Each object should contain: os, arch, and optional build-type, build-tests, build-integration-tests, run-tests, package-output, enable-xvfb, cmake-generator, mingw-version"
      artifact-name-prefix:
        required: false
        type: string
        default: ""
        description: "Prefix for artifact names"

jobs:
  build:
    name: Build ${{ matrix.arch }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(inputs.matrix-json) }}
    env:
      AXIDEV_IO_RUN_INTEGRATION_TESTS: ${{ matrix.build-integration-tests && '1' || '0' }}
      AXIDEV_IO_AUTO_CONFIRM: ${{ matrix.build-integration-tests && '1' || '0' }}
      AXIDEV_IO_INTERACTIVE: ${{ matrix.build-integration-tests && '1' || '0' }}
      DISPLAY: ${{ matrix.enable-xvfb && ':99' || '' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: ${{ inputs.package-output && 0 || 1 }}

      # Linux dependencies
      - name: Install dependencies (Linux)
        if: startsWith(matrix.os, 'ubuntu')
        run: |
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            build-essential cmake pkg-config \
            libinput-dev libxkbcommon-dev libudev-dev \
            libx11-dev libxi-dev libxtst-dev \
            libxrandr-dev libxcursor-dev libxinerama-dev
          if [ "${{ matrix.enable-xvfb }}" = "true" ]; then
            sudo apt-get install -y xvfb
            sudo modprobe uinput || true
            sudo chmod 666 /dev/uinput || true
          fi

      # macOS dependencies
      - name: Install dependencies (macOS)
        if: startsWith(matrix.os, 'macos')
        run: |
          brew update
          brew install cmake

      # Windows MinGW setup
      - name: Install MinGW-w64 (Windows)
        if: startsWith(matrix.os, 'windows')
        uses: egor-tensin/setup-mingw@v2
        with:
          platform: ${{ matrix.arch }}
          static: 0
          version: ${{ matrix.mingw-version || '13.2.0' }}

      # Start Xvfb for GUI tests on Linux
      - name: Start Xvfb (Linux)
        if: startsWith(matrix.os, 'ubuntu') && matrix.enable-xvfb
        run: |
          Xvfb :99 -screen 0 1024x768x24 & sleep 2

      # Clean build directory
      - name: Clean stale build directory
        shell: bash
        run: rm -rf build

      # Configure CMake
      - name: Configure (CMake)
        shell: bash
        run: |
          BUILD_TYPE="${{ matrix.build-type || 'Release' }}"
          CMAKE_ARGS="-S . -B build -DCMAKE_BUILD_TYPE=$BUILD_TYPE"

          # Add test flags if requested
          if [ "${{ matrix.build-tests }}" = "true" ]; then
            CMAKE_ARGS="$CMAKE_ARGS -DAXIDEV_IO_BUILD_TESTS=ON"
          fi

          if [ "${{ matrix.build-integration-tests }}" = "true" ]; then
            CMAKE_ARGS="$CMAKE_ARGS -DAXIDEV_IO_BUILD_INTEGRATION_TESTS=ON"
          fi

          # Architecture-specific flags for macOS
          if [[ "${{ matrix.os }}" == macos* ]]; then
            CMAKE_ARGS="$CMAKE_ARGS -DCMAKE_OSX_ARCHITECTURES=${{ matrix.arch }}"
          fi

          # Generator and compiler for Windows
          if [[ "${{ matrix.os }}" == windows* ]]; then
            CMAKE_ARGS="$CMAKE_ARGS -G \"Unix Makefiles\" -DCMAKE_C_COMPILER=gcc -DCMAKE_CXX_COMPILER=g++"
          fi

          # Custom generator if specified
          if [ -n "${{ matrix.cmake-generator }}" ]; then
            CMAKE_ARGS="$CMAKE_ARGS -G \"${{ matrix.cmake-generator }}\""
          fi

          eval cmake $CMAKE_ARGS

      # Build
      - name: Build (CMake)
        run: cmake --build build --config ${{ matrix.build-type || 'Release' }} --parallel

      # Run tests with ctest
      - name: Run tests (ctest)
        if: matrix.run-tests
        env:
          CTEST_OUTPUT_ON_FAILURE: 1
        run: ctest --test-dir build --output-on-failure -C ${{ matrix.build-type || 'Release' }}

      # Install for packaging
      - name: Install
        if: matrix.package-output
        run: cmake --install build --prefix dist --config ${{ matrix.build-type || 'Release' }}

      # Package for release (Unix)
      - name: Package (Unix)
        if: matrix.package-output && !startsWith(matrix.os, 'windows')
        shell: bash
        env:
          INPUT_VERSION: ${{ github.event.inputs.version || '' }}
        run: |
          TAG="${INPUT_VERSION:-${GITHUB_REF#refs/tags/}}"
          mkdir -p packages
          OS_NAME="${{ matrix.os }}"
          if [[ "$OS_NAME" == ubuntu* ]]; then
            OS_SIMPLE="linux"
          elif [[ "$OS_NAME" == macos* ]]; then
            OS_SIMPLE="macos"
          fi
          tar -C dist -czf "packages/axidev-io-${TAG}-${OS_SIMPLE}-${{ matrix.arch }}.tar.gz" .

      # Package for release (Windows)
      - name: Package (Windows)
        if: matrix.package-output && startsWith(matrix.os, 'windows')
        shell: pwsh
        env:
          INPUT_VERSION: ${{ github.event.inputs.version || '' }}
        run: |
          $tag = if ($env:INPUT_VERSION) { $env:INPUT_VERSION } else { $env:GITHUB_REF -replace '^refs/tags/', '' }
          New-Item -ItemType Directory -Path packages -Force | Out-Null
          Compress-Archive -Path "dist\*" -DestinationPath "packages/axidev-io-$tag-windows-${{ matrix.arch }}.zip" -Force

      # Upload release packages
      - name: Upload release package
        if: matrix.package-output
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact-name-prefix }}release-package-${{ matrix.os }}-${{ matrix.arch }}
          path: |
            packages/*.tar.gz
            packages/*.zip

      # Find and upload integration test binary (Unix)
      - name: Find integration test binary (Unix)
        if: matrix.build-integration-tests && !startsWith(matrix.os, 'windows')
        id: find-integration-binary-unix
        shell: bash
        run: |
          found=$(find build -type f -name 'axidev-io-integration-tests*' -print -quit || true)
          if [ -n "$found" ]; then
            bname=$(basename "$found")
            cp "$found" "$bname"
            echo "path=$bname" >> $GITHUB_OUTPUT
          else
            echo "path=" >> $GITHUB_OUTPUT
          fi

      # Find and upload integration test binary (Windows)
      - name: Find integration test binary (Windows)
        if: matrix.build-integration-tests && startsWith(matrix.os, 'windows')
        id: find-integration-binary-windows
        shell: pwsh
        run: |
          $found = Get-ChildItem -Path build -Recurse -File -ErrorAction SilentlyContinue | Where-Object { $_.Name -like 'axidev-io-integration-tests*.exe' } | Select-Object -First 1
          if ($found) {
            Copy-Item $found.FullName -Destination $found.Name
            echo "path=$($found.Name)" >> $env:GITHUB_OUTPUT
          } else {
            echo "path=" >> $env:GITHUB_OUTPUT
          }

      - name: Upload integration test binary
        if: matrix.build-integration-tests && ((steps.find-integration-binary-unix.outputs.path || '') != '' || (steps.find-integration-binary-windows.outputs.path || '') != '')
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact-name-prefix }}integration-test-binary-${{ matrix.os }}-${{ matrix.arch }}
          path: |
            axidev-io-integration-tests*
            !axidev-io-integration-tests*.o
            !axidev-io-integration-tests*.obj

      # Find and upload test-consumer binary (Unix)
      - name: Find test-consumer binary (Unix)
        if: matrix.build-integration-tests && !startsWith(matrix.os, 'windows')
        id: find-consumer-binary-unix
        shell: bash
        run: |
          found=$(find build -type f \( -name 'axidev_io_consumer*' -o -name 'axidev-io-test-consumer*' \) -print -quit || true)
          if [ -n "$found" ]; then
            bname=$(basename "$found")
            cp "$found" "$bname"
            echo "path=$bname" >> $GITHUB_OUTPUT
          else
            echo "path=" >> $GITHUB_OUTPUT
          fi

      # Find and upload test-consumer binary (Windows)
      - name: Find test-consumer binary (Windows)
        if: matrix.build-integration-tests && startsWith(matrix.os, 'windows')
        id: find-consumer-binary-windows
        shell: pwsh
        run: |
          $found = Get-ChildItem -Path build -Recurse -File -ErrorAction SilentlyContinue | Where-Object { $_.Name -like 'axidev_io_consumer*.exe' -or $_.Name -like 'axidev-io-test-consumer*.exe' } | Select-Object -First 1
          if ($found) {
            Copy-Item $found.FullName -Destination $found.Name
            echo "path=$($found.Name)" >> $env:GITHUB_OUTPUT
          } else {
            echo "path=" >> $env:GITHUB_OUTPUT
          }

      - name: Upload test-consumer binary
        if: matrix.build-integration-tests && ((steps.find-consumer-binary-unix.outputs.path || '') != '' || (steps.find-consumer-binary-windows.outputs.path || '') != '')
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact-name-prefix }}test-consumer-binary-${{ matrix.os }}-${{ matrix.arch }}
          path: |
            axidev_io_consumer*
            axidev-io-test-consumer*
            !axidev_io_consumer*.o
            !axidev_io_consumer*.obj
            !axidev-io-test-consumer*.o
            !axidev-io-test-consumer*.obj
